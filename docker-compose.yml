services:
  # Database
  db:
    image: postgres:15-alpine
    container_name: interactive-classroom-db
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-interactive_classroom}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - ${DB_PORT:-10201}:5432
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U ${DB_USER:-postgres}
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - interactive-classroom-network
  
  # Database Initialization
  db-init:
    build:
      context: https://github.com/1202-modules/interactive-classroom-api.git#dev
      dockerfile: Dockerfile
    container_name: interactive-classroom-db-init
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_NAME: ${DB_NAME:-interactive_classroom}
    depends_on:
      db:
        condition: service_healthy
    command: sh -c "python -m scripts.init_db && tail -f /dev/null"
    restart: no
    networks:
      - interactive-classroom-network
  # Database Web UI
  db-admin:
    image: adminer:4
    container_name: interactive-classroom-db-admin
    environment:
      ADMINER_DEFAULT_SERVER: db
    ports:
      - ${DB_ADMIN_PORT:-10203}:8080
    depends_on:
      - db
    restart: unless-stopped
    networks:
      - interactive-classroom-network
  # API Service
  api:
    build:
      context: https://github.com/1202-modules/interactive-classroom-api.git#dev
      dockerfile: Dockerfile
    container_name: interactive-classroom-api
    environment:
      API_TITLE: ${API_TITLE:-Interactive Classroom Platform API}
      API_VERSION: ${API_VERSION:-1.0.0}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_NAME: ${DB_NAME:-interactive_classroom}
      DB_ECHO: ${DB_ECHO:-false}
      SECRET_KEY: ${SECRET_KEY:-your-secret-key-change-in-production}
      ALGORITHM: ${ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-720}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      COOKIE_NAME: ${COOKIE_NAME:-refresh-token}
      COOKIE_HTTP_ONLY: ${COOKIE_HTTP_ONLY:-true}
      COOKIE_SECURE: ${COOKIE_SECURE:-true}
      COOKIE_SAME_SITE: ${COOKIE_SAME_SITE:-lax}
      COOKIE_MAX_AGE: ${COOKIE_MAX_AGE:-604800}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-}
      SMTP_USE_TLS: ${SMTP_USE_TLS:-true}
      VERIFICATION_CODE_EXPIRE_MINUTES: ${VERIFICATION_CODE_EXPIRE_MINUTES:-15}
      VERIFICATION_CODE_LENGTH: ${VERIFICATION_CODE_LENGTH:-6}
      GUEST_TOKEN_EXPIRE_DAYS: ${GUEST_TOKEN_EXPIRE_DAYS:-90}
      ANONYMOUS_SLUG_PREFIX: ${ANONYMOUS_SLUG_PREFIX:-anon_}
      ANONYMOUS_DISPLAY_NAME_PREFIX: ${ANONYMOUS_DISPLAY_NAME_PREFIX:-Guest_}
      CLOUDPUB_TOKEN: ${CLOUDPUB_TOKEN:-your-cloudpub-token}
      API_PORT: ${API_PORT:-10200}
      FRONT_PORT: ${FRONT_PORT:-10202}
    ports:
      - ${API_PORT:-10200}:8000
    depends_on:
      db:
        condition: service_healthy
      db-init:
        condition: service_started
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - import urllib.request;
          urllib.request.urlopen('http://localhost:8000/health')
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - interactive-classroom-network
  # Frontend Service
  front:
    build:
      context: https://github.com/1202-modules/interactive-classroom-frontend.git#dev
      dockerfile: docker/Dockerfile
    container_name: interactive-classroom-front
    ports:
      - ${FRONT_PORT:-10202}:80
    depends_on:
      - api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--output-document=/dev/null", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - interactive-classroom-network
volumes:
  postgres_data: null
networks:
  interactive-classroom-network:
    driver: bridge
